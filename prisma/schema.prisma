// ML Allure Platform - Comprehensive Prisma Schema
// PostgreSQL database with UUID primary keys

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  INVENTORY_MANAGER
  SALES_STAFF
  CUSTOMER
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  READY_FOR_PICKUP
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  MOBILE_MONEY
  CASH_ON_DELIVERY
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum DeliveryMethod {
  HOME_DELIVERY
  STORE_PICKUP
}

enum OrderSource {
  ONLINE
  IN_STORE
}

enum TransactionMethod {
  MOBILE_MONEY
  CASH
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum InventoryChangeType {
  SALE
  RESTOCK
  ADJUSTMENT
  RETURN
}

// ============================================
// MODELS
// ============================================

model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  password  String
  role      UserRole @default(CUSTOMER)
  firstName String
  lastName  String
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  inventoryLogs        InventoryLog[]
  verifiedTransactions Transaction[]       @relation("VerifiedByUser")
  orderStatusChanges   OrderStatusHistory[]

  @@map("users")
}

model Customer {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @db.Uuid // Optional - for registered users
  email     String
  firstName String
  lastName  String
  phone     String?
  isGuest   Boolean  @default(false)
  addresses Json?    // Array of address objects
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders Order[]

  @@map("customers")
}

model Category {
  id           String   @id @default(uuid()) @db.Uuid
  name         String   @unique // French: "Hommes", "Femmes", "Accessoires", etc.
  slug         String   @unique
  description  String?
  imageUrl     String?
  isActive     Boolean  @default(true)
  displayOrder Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  products Product[]

  @@map("categories")
}

model Product {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   // French
  slug        String   @unique
  description String?  @db.Text // French description
  categoryId  String   @db.Uuid
  basePrice   Decimal  @db.Decimal(10, 2)
  currency    String   @default("USD")
  images      Json?    // Array of image URLs
  isActive    Boolean  @default(true)
  isFeatured  Boolean  @default(false)
  tags        String[] // Array of tags
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  category   Category         @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  variants   ProductVariant[]
  orderItems OrderItem[]

  @@map("products")
}

model ProductVariant {
  id              String   @id @default(uuid()) @db.Uuid
  productId       String   @db.Uuid
  sku             String   @unique // Auto-generated
  size            String   // "S", "M", "L", "XL", "38", "40"
  color           String   // French: "Rouge", "Bleu", "Noir"
  colorHex        String   // For display
  stockQuantity   Int      @default(0)
  additionalPrice Decimal  @default(0) @db.Decimal(10, 2)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  product       Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventoryLogs InventoryLog[]
  orderItems    OrderItem[]

  @@map("product_variants")
}

model Order {
  id               String         @id @default(uuid()) @db.Uuid
  orderNumber      String         @unique // Format: "MLA-YYYYMMDD-XXXX"
  customerId       String         @db.Uuid
  status           OrderStatus    @default(PENDING)
  paymentMethod    PaymentMethod
  paymentStatus    PaymentStatus  @default(PENDING)
  paymentReference String?
  deliveryMethod   DeliveryMethod
  deliveryAddress  Json?          // Delivery address object
  deliveryZone     String?        // "Gombe", "Kinshasa"
  deliveryFee      Decimal        @db.Decimal(10, 2)
  subtotal         Decimal        @db.Decimal(10, 2)
  total            Decimal        @db.Decimal(10, 2)
  source           OrderSource    @default(ONLINE)
  notes            String?        @db.Text
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  completedAt      DateTime?

  // Relations
  customer       Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  orderItems     OrderItem[]
  transactions   Transaction[]
  inventoryLogs  InventoryLog[]
  statusHistory  OrderStatusHistory[]

  @@map("orders")
}

model OrderStatusHistory {
  id         String      @id @default(uuid()) @db.Uuid
  orderId    String      @db.Uuid
  fromStatus OrderStatus?
  toStatus   OrderStatus
  changedBy  String?     @db.Uuid
  notes      String?
  createdAt  DateTime    @default(now())

  // Relations
  order Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User?  @relation(fields: [changedBy], references: [id], onDelete: SetNull)

  @@map("order_status_history")
}

model OrderItem {
  id              String   @id @default(uuid()) @db.Uuid
  orderId         String   @db.Uuid
  productId       String   @db.Uuid
  variantId       String   @db.Uuid
  quantity        Int
  priceAtPurchase Decimal  @db.Decimal(10, 2)
  productName     String   // Snapshot
  variantDetails  Json?    // Snapshot of variant details
  createdAt       DateTime @default(now())

  // Relations
  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product        @relation(fields: [productId], references: [id], onDelete: Restrict)
  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Restrict)

  @@map("order_items")
}

model Transaction {
  id         String            @id @default(uuid()) @db.Uuid
  orderId    String            @db.Uuid
  amount     Decimal           @db.Decimal(10, 2)
  method     TransactionMethod
  provider   String?           // "M-Pesa", "Airtel Money", "Orange Money"
  reference  String?
  status     TransactionStatus @default(PENDING)
  verifiedBy String?           @db.Uuid
  verifiedAt DateTime?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  // Relations
  order    Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  verifier User? @relation("VerifiedByUser", fields: [verifiedBy], references: [id], onDelete: SetNull)

  @@map("transactions")
}

model InventoryLog {
  id               String              @id @default(uuid()) @db.Uuid
  variantId        String              @db.Uuid
  changeType       InventoryChangeType
  quantityChange   Int                 // Can be negative
  previousQuantity Int
  newQuantity      Int
  reason           String
  performedBy      String              @db.Uuid
  orderId          String?             @db.Uuid
  createdAt        DateTime            @default(now())

  // Relations
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  performer User           @relation(fields: [performedBy], references: [id], onDelete: Restrict)
  order     Order?         @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@map("inventory_logs")
}